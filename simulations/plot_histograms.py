# Read apparent magnitude files generated by SHAM interpolation, and plot:
# - magnitude histograms
# - color histograms
# - color scatter plots
# - redshift histograms
# - absolute magnitude histograms
from matplotlib import pyplot as plt
import numpy as np

import directories

from load_sham_galaxies import load_sham_galaxies

from sham_model_constants import BLUE, RED

# Parameters for plotting
bin_count = 70
LINEWIDTH = 1.5
ALPHA = 0.5

# Color choices
blue = "#004488"
yellow = "#ddaa33"
red = "#bb5566"
orange = "#EE7733"
teal = "#009988"

plt.rcParams["font.size"] = "12"
plt.rcParams["figure.figsize"] = (9, 6)

# Number of particles (cube root) used in run
# This determines the path where the data is stored
PARTICLE_COUNT_PINOCCHIO = 2048
Z_DEPTH = 0.5
PINOCCHIO_REGION = "fullsky"
DESI_region = directories.BASS_MzLS
run_id = 146

# Load galaxy data from SHAM
galaxies = load_sham_galaxies(
    particle_count=PARTICLE_COUNT_PINOCCHIO,
    z_depth=Z_DEPTH,
    pinocchio_region=PINOCCHIO_REGION,
    DESI_region=DESI_region,
    run_id=run_id,
)

print("Number of objects:", len(galaxies["mag_r"]))

# Separate red and blue galaxies
red_mask = galaxies["blue_red"] == RED
blue_mask = galaxies["blue_red"] == BLUE
red_galaxies = {k: v[red_mask] for k, v in galaxies.items()}
blue_galaxies = {k: v[blue_mask] for k, v in galaxies.items()}

####################
# Determine binning for each color band
bins = {
    "g": np.linspace(15, 22, bin_count),
    "r": np.linspace(14, 20.5, bin_count),
    "z": np.linspace(15, 20.5, bin_count),
}

for band in bins.keys():
    plt.hist(
        galaxies[f"mag_{band}"],
        bins=bins[band],
        color=teal,
    )

    plt.xlim([14, 22])

    plt.title("SHAM apparent magnitudes, BASS-MzLS filters")
    plt.xlabel(f"{band} apparent magnitude")
    plt.ylabel("Count")

    plt.grid()
    plt.savefig(f"/cluster/home/lmachado/msc-thesis/simulations/images/{band}mag_hist_simulated.pdf")

    plt.show()

####################
# Plot redshift distribution of reds and blues for each r-magnitude bin
rmag_bins = [
    [15, 16],
    [16, 17],
    [17, 18],
    [18, 19],
    [19, 19.5],
]
COLORS = {
    15: "C0",
    16: "C1",
    17: "C2",
    18: "C3",
    19: "C4",
}

LINESTYLES = {
    "blue": "solid",
    "red": "dashed",
}
HISTTYPES = {
    "blue": "step",
    "red": "stepfilled",
}
ALPHAS = {
    "blue": 1,
    "red": 0.4,
}

fig, ax = plt.subplots(1, 1)

for g, color in (
        (blue_galaxies, "blue"),
        (red_galaxies, "red"),
    ):

    for rmag_low, rmag_high in rmag_bins:
        tmp_mask = (g["mag_r"] >= rmag_low) & (g["mag_r"] < rmag_high)

        ax.hist(
            g["redshift"][tmp_mask],
            label=f"{rmag_low:.1f} < r < {rmag_high:.1f}, {color.capitalize()}",
            color=COLORS[rmag_low],
            bins=40,
            histtype=HISTTYPES[color],
            alpha=ALPHAS[color],
            density=True,
            lw=2,
            ls=LINESTYLES[color],
        )

ax.set_xlabel("Redshift")
ax.set_ylabel("PDF")

ax.set_xlim([0, 0.5])
ax.set_ylim([0, 25])

ax.set_title("Blue vs. Red galaxies, redshift distribution")

ax.legend(ncol=2)

ax.grid()

fig.savefig(f"/cluster/home/lmachado/msc-thesis/simulations/images/SHAM_redshift_distributions_{DESI_region}.pdf")

plt.show()

####################
# Plot abs. mag. distribution of reds and blues,
# to show that reds are brighter than blues
fig, ax = plt.subplots(1, 1)

for g, color in (
        (blue_galaxies, "blue"),
        (red_galaxies, "red"),
    ):

    ax.hist(
        g["abs_mag"],
        label=f"{color.capitalize()}",
        color=color,
        bins=40,
        histtype="step",
        density=True,
        lw=2,
        ls=LINESTYLES[color],
    )

ax.set_xlabel("Absolute Magnitude")
ax.set_ylabel("PDF")

ax.set_title("Blue vs. Red galaxies, absolute magnitude distribution")

ax.legend()

ax.grid()

fig.savefig(f"/cluster/home/lmachado/msc-thesis/simulations/images/SHAM_absmag_distributions_{DESI_region}.png")

plt.show()

####################
# TODO create sbatch script, since it requires lots of memory
# TODO also compare redshift distributions for different r bins,
# TODO which will require computing apparent magnitudes (probably within the sample.py code)
# Load UCat sampled galaxies, and plot absolute magnitudes for reds and blues,
# to verify that distribution is similar to the one obtained by SHAM
UCAT_OUTPUT_PATH = directories.outputs_sampling_path(
    particle_count=PARTICLE_COUNT_PINOCCHIO,
    z_depth=Z_DEPTH,
    pinocchio_region=PINOCCHIO_REGION,
    DESI_region=DESI_region,
)

ucat_output = {}

ucat_output["abs_mag"] = np.load(f"{UCAT_OUTPUT_PATH}/sampled_absmag.npy")
ucat_output["blue_red"] = np.load(f"{UCAT_OUTPUT_PATH}/sampled_redblue.npy")
ucat_output["redshift"] = np.load(f"{UCAT_OUTPUT_PATH}/sampled_z.npy")

# Separate red and blue galaxies
blue_mask = ucat_output["blue_red"] == BLUE
red_mask = ucat_output["blue_red"] == RED
blue_ucat_output = {k: v[blue_mask] for k, v in ucat_output.items()}
red_ucat_output = {k: v[red_mask] for k, v in ucat_output.items()}

fig, ax = plt.subplots(1, 1)

for g, color in (
        (blue_ucat_output, "blue"),
        (red_ucat_output, "red"),
    ):

    ax.hist(
        g["abs_mag"],
        label=f"{color.capitalize()}",
        color=color,
        bins=40,
        histtype="step",
        density=True,
        lw=2,
        ls=LINESTYLES[color],
    )

ax.set_xlabel("Absolute Magnitude")
ax.set_ylabel("PDF")

ax.set_title("UCat: Blue vs. Red galaxies, absolute magnitude distribution")

ax.legend()

ax.grid()

fig.savefig(f"/cluster/home/lmachado/msc-thesis/simulations/images/UCAT_absmag_distributions_{DESI_region}.png")

plt.show()
